import time
import hmac
import hashlib
import base64
import requests
import json
import os
import matplotlib.pyplot as plt
import matplotlib.dates as mdates
from datetime import datetime

# ğŸ”‘ Bitget API í‚¤ ì •ë³´
API_KEY = ''
SECRET_KEY = ''
PASSPHRASE = ''

# ğŸŸ¢ ê³„ì • ìœ í˜• ì„¤ì •: 'futures' ë˜ëŠ” 'spot'
ACCOUNT_TYPE = 'futures'  # ë˜ëŠ” 'spot'

# ğŸ“‚ ë°ì´í„° ì €ì¥ íŒŒì¼ ê²½ë¡œ
HISTORY_FILE = 'bots_balance_history.json'

# Bitget API ì—”ë“œí¬ì¸íŠ¸
BASE_URL = 'https://api.bitget.com'
REQUEST_PATH = '/api/v2/account/bot-assets'

# âœ… API ìš”ì²­ í•¨ìˆ˜: ë´‡ ê³„ì •ì˜ ìì‚° ì •ë³´ ê°€ì ¸ì˜¤ê¸°
def get_bots_balance():
    timestamp = str(int(time.time() * 1000))
    method = 'GET'
    request_path = f'{REQUEST_PATH}?accountType={ACCOUNT_TYPE}'
    url = f'{BASE_URL}{request_path}'

    # ğŸ› ï¸ ì„œëª…(Signature) ìƒì„±
    prehash = timestamp + method + request_path
    hmac_key = hmac.new(SECRET_KEY.encode('utf-8'), prehash.encode('utf-8'), hashlib.sha256)
    signature = base64.b64encode(hmac_key.digest()).decode()

    # âœ… API ìš”ì²­ í—¤ë” ì„¤ì •
    headers = {
        'ACCESS-KEY': API_KEY,
        'ACCESS-SIGN': signature,
        'ACCESS-PASSPHRASE': PASSPHRASE,
        'ACCESS-TIMESTAMP': timestamp,
        'Content-Type': 'application/json'
    }

    try:
        response = requests.get(url, headers=headers)
        data = response.json()

        if response.status_code == 200 and data['code'] == '00000':
            if "data" in data and len(data["data"]) > 0:
                return {
                    'timestamp': timestamp,
                    'equity': float(data["data"][0]["equity"])  # âœ… ì´ ìì‚° (equity) ê°’ ê°€ì ¸ì˜¤ê¸°
                }
        else:
            print(f"âš ï¸ API ì˜¤ë¥˜: {data.get('msg', 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜')}")
            return None
    except Exception as e:
        print(f"âŒ ìš”ì²­ ì‹¤íŒ¨: {e}")
        return None

# âœ… ìì‚° ì¶”ì´ë¥¼ JSON íŒŒì¼ì— ì €ì¥í•˜ëŠ” í•¨ìˆ˜
def save_balance_history(new_data):
    if not new_data:
        return

    # ê¸°ì¡´ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ì—†ìœ¼ë©´ ë¹ˆ ë¦¬ìŠ¤íŠ¸)
    if os.path.exists(HISTORY_FILE):
        with open(HISTORY_FILE, 'r', encoding='utf-8') as file:
            try:
                history = json.load(file)
            except json.JSONDecodeError:
                history = []
    else:
        history = []

    # ìƒˆ ë°ì´í„° ì¶”ê°€
    history.append(new_data)

    # JSON íŒŒì¼ ì €ì¥
    with open(HISTORY_FILE, 'w', encoding='utf-8') as file:
        json.dump(history, file, ensure_ascii=False, indent=4)

    print(f"âœ… ìì‚° ê¸°ë¡ ì €ì¥ë¨: {new_data}")

# âœ… ì‹¤ì‹œê°„ ê·¸ë˜í”„ ê·¸ë¦¬ê¸° (ê¸°ì¡´ ì°½ì„ ì¬ì‚¬ìš©)
def plot_balance_history():
    if not os.path.exists(HISTORY_FILE):
        print("âš ï¸ ê¸°ë¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return

    with open(HISTORY_FILE, 'r', encoding='utf-8') as file:
        history = json.load(file)

    if len(history) < 2:
        print("âš ï¸ ê·¸ë˜í”„ë¥¼ ê·¸ë¦´ ì¶©ë¶„í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return

    timestamps = [datetime.fromtimestamp(int(item['timestamp']) / 1000) for item in history]
    equities = [item['equity'] for item in history]

    plt.clf()  # âœ… ê¸°ì¡´ ê·¸ë˜í”„ ì´ˆê¸°í™” (ìƒˆë¡œìš´ ì°½ ìƒì„± ë°©ì§€)
    plt.plot(timestamps, equities, marker='o', linestyle='-', color='b', label='ì´ ìì‚° (Equity)')

    plt.xlabel('ì‹œê°„')
    plt.ylabel('ì´ ìì‚° (USDT)')
    plt.title('Bots ê³„ì • ì´ ìì‚° ì¶”ì´')
    plt.legend()
    plt.grid(True)

    # ë‚ ì§œ í¬ë§· ì„¤ì •
    plt.gca().xaxis.set_major_formatter(mdates.DateFormatter('%H:%M:%S'))
    plt.gcf().autofmt_xdate()

    plt.pause(1)  # âœ… ê·¸ë˜í”„ ì—…ë°ì´íŠ¸ í›„ ë©ˆì¶”ì§€ ì•Šë„ë¡ í•¨

# âœ… 1ë¶„ë§ˆë‹¤ ë°ì´í„° ê°±ì‹ 
def track_balance():
    plt.ion()  # âœ… Matplotlib ì¸í„°ë™í‹°ë¸Œ ëª¨ë“œ í™œì„±í™” (ì°½ í•˜ë‚˜ë§Œ ìœ ì§€)
    print("\nğŸ“Š Bots ê³„ì • ìì‚° ì¶”ì  ì‹œì‘... (1ë¶„ë§ˆë‹¤ ê°±ì‹ )\n")
    while True:
        balance_data = get_bots_balance()
        if balance_data:
            save_balance_history(balance_data)
            plot_balance_history()  # âœ… ë°ì´í„°ë¥¼ ì €ì¥í•  ë•Œë§ˆë‹¤ ê·¸ë˜í”„ë„ ì—…ë°ì´íŠ¸
        time.sleep(5)  # 1ë¶„ ëŒ€ê¸° í›„ ë‹¤ì‹œ ì‹¤í–‰

# í”„ë¡œê·¸ë¨ ì‹¤í–‰
if __name__ == "__main__":
    track_balance()
